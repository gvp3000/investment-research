<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Research Hub - Full Stack</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
            color: #1a1a1a;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
        }

        nav {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        nav ul {
            list-style: none;
            display: flex;
            justify-content: center;
            gap: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            flex-wrap: wrap;
        }

        nav button {
            background: none;
            border: none;
            color: #fff;
            font-weight: 500;
            font-size: 1.1rem;
            cursor: pointer;
            padding: 0.5rem 0;
            transition: all 0.3s;
            position: relative;
        }

        nav button::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 0;
            height: 2px;
            background: #4CAF50;
            transition: width 0.3s;
        }

        nav button:hover::after { width: 100%; }
        nav button.active { color: #4CAF50; }
        nav button.active::after { width: 100%; }

        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }

        .page-section {
            display: none;
            background: white;
            margin: 2rem 0;
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .page-section.active { display: block; }

        h1 { font-size: 2.5rem; margin-bottom: 1rem; }
        h2 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            font-size: 2rem;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 0.5rem;
        }
        h3 { color: #34495e; margin-bottom: 1rem; font-size: 1.4rem; }

        .hero {
            text-align: center;
            padding: 3rem 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            margin-bottom: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            display: block;
        }

        .stat-label {
            color: #5a6c7d;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .asset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .asset-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .asset-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.4);
        }

        .asset-card h3 { color: white; font-size: 1.8rem; margin-bottom: 0.5rem; }
        .asset-card p { opacity: 0.9; }

        .research-detail { display: none; margin-top: 2rem; }
        .research-detail.active { display: block; }

        .info-box {
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .price-box {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }

        .overview-box {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        }

        .trigger-box {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe8a1 100%);
            border-left: 4px solid #ffc107;
        }

        .trigger-box h4 { color: #856404; margin-bottom: 1rem; }

        .trigger-item {
            padding: 0.8rem;
            margin: 0.5rem 0;
            background: rgba(255,255,255,0.6);
            border-radius: 6px;
        }

        .blog-post {
            background: #f8f9fa;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }

        .blog-post:hover { transform: translateX(8px); }
        .blog-post h4 { color: #2c3e50; margin-bottom: 0.5rem; }
        .blog-post .date { color: #7f8c8d; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .blog-post-content { display: none; margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #e0e0e0; }
        .blog-post-content.active { display: block; }

        .btn {
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            font-size: 1rem;
            font-weight: 500;
            margin: 0.5rem 0.5rem 0.5rem 0;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 2.5rem;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal input, .modal textarea, .modal select {
            width: 100%;
            padding: 1rem;
            margin: 0.8rem 0;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
        }

        .modal input:focus, .modal textarea:focus, .modal select:focus {
            outline: none;
            border-color: #667eea;
        }

        .portfolio-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 1.5rem;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .portfolio-table th {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 1.2rem;
            text-align: left;
        }

        .portfolio-table td {
            padding: 1.2rem;
            border-bottom: 1px solid #e0e0e0;
            background: white;
        }

        .portfolio-table tr:hover td { background: #f8f9fa; }
        .positive { color: #4CAF50; font-weight: 600; }
        .negative { color: #f44336; font-weight: 600; }

        .todo-list { list-style: none; margin-top: 1rem; }
        .todo-item {
            padding: 1rem;
            background: #f8f9fa;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .todo-item.completed { opacity: 0.6; text-decoration: line-through; }

        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .admin-card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .admin-card h3 {
            color: #667eea;
            margin-bottom: 1rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        @media (max-width: 768px) {
            nav ul { gap: 1rem; }
            nav button { font-size: 1rem; }
            .asset-grid { grid-template-columns: 1fr; }
            .admin-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <nav>
        <ul>
            <li><button onclick="switchPage('research')" id="nav-research" class="active">Research</button></li>
            <li><button onclick="switchPage('portfolio')" id="nav-portfolio">Portfolio</button></li>
            <li><button onclick="switchPage('todo')" id="nav-todo">To-Do</button></li>
            <li><button onclick="switchPage('admin')" id="nav-admin">Admin</button></li>
        </ul>
    </nav>

    <div class="container">
        <!-- RESEARCH SECTION -->
        <div id="page-research" class="page-section active">
            <div class="hero">
                <h1>Investment Research Hub</h1>
                <p>Full-stack platform with real-time data and CMS</p>
            </div>

            <div id="research-home">
                <h2>Research Projects</h2>
                <div class="loading">Loading assets...</div>
                <div class="asset-grid" id="asset-grid"></div>
            </div>

            <div id="asset-detail" class="research-detail"></div>
        </div>

        <!-- PORTFOLIO SECTION -->
        <div id="page-portfolio" class="page-section">
            <h2>Portfolio Overview</h2>
            <div class="loading">Loading portfolio...</div>
            <div id="portfolio-content"></div>
        </div>

        <!-- TODO SECTION -->
        <div id="page-todo" class="page-section">
            <h2>To-Do List</h2>
            <button class="btn btn-primary" onclick="openTodoModal()">+ Add To-Do</button>
            <ul class="todo-list" id="todo-list"></ul>
        </div>

        <!-- ADMIN SECTION -->
        <div id="page-admin" class="page-section">
            <h2>Admin Panel</h2>
            <p style="margin-bottom: 2rem;">Manage assets, update prices, edit content</p>
            
            <div class="admin-grid">
                <div class="admin-card">
                    <h3>üìä Update Prices</h3>
                    <p>Fetch latest prices from CoinGecko API for all crypto assets</p>
                    <button class="btn btn-primary" onclick="updateAllPrices()">Update All Prices</button>
                    <div id="price-update-status"></div>
                </div>

                <div class="admin-card">
                    <h3>‚ûï Add New Asset</h3>
                    <p>Add a new investment asset to track</p>
                    <button class="btn btn-primary" onclick="openAssetModal()">Add Asset</button>
                </div>

                <div class="admin-card">
                    <h3>‚úèÔ∏è Edit Assets</h3>
                    <p>Modify existing asset information</p>
                    <button class="btn btn-primary" onclick="loadAssetsForEdit()">Edit Assets</button>
                </div>

                <div class="admin-card">
                    <h3>üéØ Manage Triggers</h3>
                    <p>Add or edit HTF action triggers</p>
                    <button class="btn btn-primary" onclick="manageTriggers()">Manage Triggers</button>
                </div>
            </div>

            <div id="admin-content" style="margin-top: 2rem;"></div>
        </div>
    </div>

    <!-- Post Modal -->
    <div id="postModal" class="modal">
        <div class="modal-content">
            <h3>Add Research Post</h3>
            <input type="text" id="postTitle" placeholder="Title">
            <textarea id="postContent" rows="6" placeholder="Content"></textarea>
            <button class="btn btn-primary" onclick="savePost()">Save</button>
            <button class="btn btn-secondary" onclick="closeModal('postModal')">Cancel</button>
        </div>
    </div>

    <!-- Todo Modal -->
    <div id="todoModal" class="modal">
        <div class="modal-content">
            <h3>Add To-Do Item</h3>
            <input type="text" id="todoText" placeholder="What needs to be done?">
            <button class="btn btn-primary" onclick="saveTodo()">Add</button>
            <button class="btn btn-secondary" onclick="closeModal('todoModal')">Cancel</button>
        </div>
    </div>

    <!-- Asset Modal -->
    <div id="assetModal" class="modal">
        <div class="modal-content">
            <h3 id="assetModalTitle">Add New Asset</h3>
            <input type="hidden" id="assetId">
            <input type="text" id="assetSymbol" placeholder="Symbol (e.g., BTC)">
            <input type="text" id="assetName" placeholder="Full Name">
            <textarea id="assetDescription" rows="2" placeholder="Short Description"></textarea>
            <textarea id="assetThesis" rows="4" placeholder="Investment Thesis"></textarea>
            <input type="text" id="assetPosition" placeholder="Position Size (e.g., 30%)">
            <button class="btn btn-primary" onclick="saveAsset()">Save</button>
            <button class="btn btn-secondary" onclick="closeModal('assetModal')">Cancel</button>
        </div>
    </div>

    <!-- Trigger Modal -->
    <div id="triggerModal" class="modal">
        <div class="modal-content">
            <h3>Add HTF Trigger</h3>
            <select id="triggerAsset">
                <option value="">Select Asset</option>
            </select>
            <select id="triggerType">
                <option value="buy">Buy Signal</option>
                <option value="sell">Sell Signal</option>
                <option value="add">Add to Position</option>
                <option value="reduce">Reduce Position</option>
                <option value="monitor">Monitor</option>
            </select>
            <textarea id="triggerDescription" rows="3" placeholder="Trigger Description"></textarea>
            <button class="btn btn-primary" onclick="saveTrigger()">Save</button>
            <button class="btn btn-secondary" onclick="closeModal('triggerModal')">Cancel</button>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        // üî¥ REPLACE THESE WITH YOUR SUPABASE CREDENTIALS
        const SUPABASE_URL = 'https://txhgyvmqffjkgnuztxnb.supabase.co';  // e.g., 'https://xxxxx.supabase.co'
        const SUPABASE_KEY = 'sb_publishable_tk6tnApHFqI4e9DpUMslUQ_RRKILC0M';  // Your anon public key
        
        // Initialize Supabase client
        let supabase;
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } catch (error) {
            console.error('Error initializing Supabase:', error);
        }

        let currentAsset = '';
        let assetsCache = [];

        // ===== PAGE SWITCHING =====
        function switchPage(pageName) {
            document.querySelectorAll('.page-section').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById('page-' + pageName).classList.add('active');
            
            document.querySelectorAll('nav button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('nav-' + pageName).classList.add('active');
            
            if (pageName === 'research') {
                hideAssetDetail();
            } else if (pageName === 'portfolio') {
                loadPortfolio();
            } else if (pageName === 'todo') {
                loadTodos();
            }
        }

        // ===== LOAD ASSETS =====
        async function loadAssets() {
            try {
                const { data, error } = await supabase
                    .from('assets')
                    .select('*')
                    .order('symbol');

                if (error) throw error;

                assetsCache = data;
                renderAssetGrid(data);
                
                // Update prices for crypto assets
                updateCryptoPrices(data);
            } catch (error) {
                console.error('Error loading assets:', error);
                document.getElementById('asset-grid').innerHTML = 
                    '<div class="error">Error loading assets. Check console for details.</div>';
            }
        }

        function renderAssetGrid(assets) {
            const grid = document.getElementById('asset-grid');
            const loading = document.querySelector('#research-home .loading');
            if (loading) loading.style.display = 'none';

            grid.innerHTML = assets.map(asset => `
                <div class="asset-card" onclick="showAssetDetail('${asset.symbol}')">
                    <h3>${asset.symbol}</h3>
                    <p>${asset.name}</p>
                </div>
            `).join('');
        }

        // ===== UPDATE CRYPTO PRICES =====
        async function updateCryptoPrices(assets) {
            const cryptoAssets = assets.filter(a => 
                ['BTC', 'CRV', 'CVX', 'ETH'].includes(a.symbol)
            );

            const coinIds = {
                'BTC': 'bitcoin',
                'CRV': 'curve-dao-token',
                'CVX': 'convex-finance',
                'ETH': 'ethereum'
            };

            for (const asset of cryptoAssets) {
                const coinId = coinIds[asset.symbol];
                if (coinId) {
                    try {
                        const response = await fetch(
                            `https://api.coingecko.com/api/v3/simple/price?ids=${coinId}&vs_currencies=usd&include_24hr_change=true`
                        );
                        const data = await response.json();
                        
                        const price = data[coinId].usd;
                        const change = data[coinId].usd_24h_change;

                        await supabase
                            .from('assets')
                            .update({
                                current_price: price,
                                price_change_24h: change,
                                last_updated: new Date().toISOString()
                            })
                            .eq('symbol', asset.symbol);
                    } catch (error) {
                        console.error(`Error updating ${asset.symbol} price:`, error);
                    }
                }
            }
        }

        // ===== SHOW ASSET DETAIL =====
        async function showAssetDetail(symbol) {
            document.getElementById('research-home').style.display = 'none';
            document.getElementById('asset-detail').classList.add('active');
            currentAsset = symbol;

            try {
                const { data: asset, error: assetError } = await supabase
                    .from('assets')
                    .select('*')
                    .eq('symbol', symbol)
                    .single();

                if (assetError) throw assetError;

                const { data: triggers, error: triggerError } = await supabase
                    .from('triggers')
                    .select('*')
                    .eq('asset_symbol', symbol);

                const { data: posts, error: postError } = await supabase
                    .from('posts')
                    .select('*')
                    .eq('asset_symbol', symbol)
                    .order('date', { ascending: false });

                const priceBox = asset.current_price ? `
                    <div class="info-box price-box">
                        <h4>Current Price: $${parseFloat(asset.current_price).toLocaleString()}</h4>
                        <p><strong>24h Change:</strong> <span class="${asset.price_change_24h >= 0 ? 'positive' : 'negative'}">${asset.price_change_24h >= 0 ? '+' : ''}${parseFloat(asset.price_change_24h).toFixed(2)}%</span></p>
                        ${asset.recent_news ? `<p><strong>Recent News:</strong> ${asset.recent_news}</p>` : ''}
                    </div>
                ` : '';

                const overviewBox = `
                    <div class="info-box overview-box">
                        <h3>Overview</h3>
                        ${asset.thesis ? `<p><strong>Thesis:</strong> ${asset.thesis}</p>` : ''}
                        ${asset.position_size ? `<p><strong>Position Size:</strong> ${asset.position_size}</p>` : ''}
                        ${asset.technical_analysis ? `<p><strong>Technical Analysis:</strong> ${asset.technical_analysis}</p>` : ''}
                    </div>
                `;

                const triggersBox = triggers && triggers.length > 0 ? `
                    <div class="info-box trigger-box">
                        <h4>‚ö†Ô∏è HTF Action Triggers</h4>
                        ${triggers.map(t => `
                            <div class="trigger-item">
                                <strong>${t.trigger_type.toUpperCase()}:</strong> ${t.description}
                            </div>
                        `).join('')}
                    </div>
                ` : '';

                const postsSection = `
                    <div class="blog-posts">
                        <h3>Research Posts</h3>
                        <button class="btn btn-primary" onclick="openPostModal('${symbol}')">+ Add Post</button>
                        <div id="posts-container">
                            ${posts && posts.length > 0 ? posts.map(post => `
                                <div class="blog-post" onclick="togglePost(this)">
                                    <h4>${escapeHtml(post.title)}</h4>
                                    <div class="date">${new Date(post.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
                                    <p>${escapeHtml(post.content.substring(0, 100))}${post.content.length > 100 ? '...' : ''}</p>
                                    <div class="blog-post-content">
                                        <p>${escapeHtml(post.content)}</p>
                                        <button class="btn btn-danger" onclick="deletePost(event, ${post.id})">Delete</button>
                                    </div>
                                </div>
                            `).join('') : '<p>No posts yet. Add your first research note!</p>'}
                        </div>
                    </div>
                `;

                document.getElementById('asset-detail').innerHTML = `
                    <button class="btn btn-secondary" onclick="hideAssetDetail()">‚Üê Back</button>
                    <h2>${asset.name} (${asset.symbol})</h2>
                    ${priceBox}
                    ${overviewBox}
                    ${triggersBox}
                    ${postsSection}
                `;

            } catch (error) {
                console.error('Error loading asset details:', error);
                document.getElementById('asset-detail').innerHTML = 
                    '<div class="error">Error loading asset details</div>';
            }
        }

        function hideAssetDetail() {
            document.getElementById('research-home').style.display = 'block';
            document.getElementById('asset-detail').classList.remove('active');
        }

        function togglePost(el) {
            const content = el.querySelector('.blog-post-content');
            content.classList.toggle('active');
        }

        // ===== POSTS =====
        function openPostModal(symbol) {
            currentAsset = symbol;
            document.getElementById('postModal').style.display = 'block';
        }

        async function savePost() {
            const title = document.getElementById('postTitle').value.trim();
            const content = document.getElementById('postContent').value.trim();
            
            if (!title || !content) {
                alert('Please fill in both title and content');
                return;
            }

            try {
                const { error } = await supabase
                    .from('posts')
                    .insert([{
                        asset_symbol: currentAsset,
                        title,
                        content
                    }]);

                if (error) throw error;

                closeModal('postModal');
                showAssetDetail(currentAsset); // Refresh
            } catch (error) {
                console.error('Error saving post:', error);
                alert('Error saving post');
            }
        }

        async function deletePost(event, postId) {
            event.stopPropagation();
            if (!confirm('Delete this post?')) return;

            try {
                const { error } = await supabase
                    .from('posts')
                    .delete()
                    .eq('id', postId);

                if (error) throw error;

                showAssetDetail(currentAsset); // Refresh
            } catch (error) {
                console.error('Error deleting post:', error);
                alert('Error deleting post');
            }
        }

        // ===== PORTFOLIO =====
        async function loadPortfolio() {
            try {
                const { data, error } = await supabase
                    .from('portfolio')
                    .select(`
                        *,
                        assets (symbol, name, current_price)
                    `)
                    .order('allocation_percent', { ascending: false });

                if (error) throw error;

                const container = document.getElementById('portfolio-content');
                container.innerHTML = `
                    <table class="portfolio-table">
                        <thead>
                            <tr>
                                <th>Asset</th>
                                <th>Allocation</th>
                                <th>Entry</th>
                                <th>Current</th>
                                <th>P&L</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(item => `
                                <tr>
                                    <td><strong>${item.asset_symbol}</strong></td>
                                    <td>${item.allocation_percent}%</td>
                                    <td>${item.entry_price}</td>
                                    <td>${item.current_price}</td>
                                    <td class="${item.pnl_percent >= 0 ? 'positive' : 'negative'}">
                                        ${item.pnl_percent >= 0 ? '+' : ''}${item.pnl_percent}%
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading portfolio:', error);
            }
        }

        // ===== TODOS =====
        async function loadTodos() {
            try {
                const { data, error } = await supabase
                    .from('todos')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const list = document.getElementById('todo-list');
                list.innerHTML = data.map(todo => `
                    <li class="todo-item ${todo.completed ? 'completed' : ''}">
                        <span>${escapeHtml(todo.text)}</span>
                        <div>
                            <button class="btn btn-secondary" onclick="toggleTodo(${todo.id}, ${!todo.completed})">${todo.completed ? 'Undo' : 'Complete'}</button>
                            <button class="btn btn-danger" onclick="deleteTodo(${todo.id})">Delete</button>
                        </div>
                    </li>
                `).join('');
            } catch (error) {
                console.error('Error loading todos:', error);
            }
        }

        function openTodoModal() {
            document.getElementById('todoModal').style.display = 'block';
        }

        async function saveTodo() {
            const text = document.getElementById('todoText').value.trim();
            if (!text) {
                alert('Please enter a task');
                return;
            }

            try {
                const { error } = await supabase
                    .from('todos')
                    .insert([{ text, completed: false }]);

                if (error) throw error;

                closeModal('todoModal');
                loadTodos();
            } catch (error) {
                console.error('Error saving todo:', error);
                alert('Error saving todo');
            }
        }

        async function toggleTodo(id, completed) {
            try {
                const { error } = await supabase
                    .from('todos')
                    .update({ completed })
                    .eq('id', id);

                if (error) throw error;

                loadTodos();
            } catch (error) {
                console.error('Error updating todo:', error);
            }
        }

        async function deleteTodo(id) {
            if (!confirm('Delete this task?')) return;

            try {
                const { error } = await supabase
                    .from('todos')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                loadTodos();
            } catch (error) {
                console.error('Error deleting todo:', error);
            }
        }

        // ===== ADMIN FUNCTIONS =====
        async function updateAllPrices() {
            const statusDiv = document.getElementById('price-update-status');
            statusDiv.innerHTML = '<div class="loading">Updating prices...</div>';

            try {
                await updateCryptoPrices(assetsCache);
                await loadAssets(); // Reload to get fresh data
                
                statusDiv.innerHTML = '<div class="success">‚úì Prices updated successfully!</div>';
                setTimeout(() => statusDiv.innerHTML = '', 3000);
            } catch (error) {
                console.error('Error updating prices:', error);
                statusDiv.innerHTML = '<div class="error">Error updating prices</div>';
            }
        }

        function openAssetModal(asset = null) {
            document.getElementById('assetModalTitle').textContent = asset ? 'Edit Asset' : 'Add New Asset';
            
            if (asset) {
                document.getElementById('assetId').value = asset.id;
                document.getElementById('assetSymbol').value = asset.symbol;
                document.getElementById('assetName').value = asset.name;
                document.getElementById('assetDescription').value = asset.description || '';
                document.getElementById('assetThesis').value = asset.thesis || '';
                document.getElementById('assetPosition').value = asset.position_size || '';
            } else {
                document.getElementById('assetId').value = '';
                document.getElementById('assetSymbol').value = '';
                document.getElementById('assetName').value = '';
                document.getElementById('assetDescription').value = '';
                document.getElementById('assetThesis').value = '';
                document.getElementById('assetPosition').value = '';
            }
            
            document.getElementById('assetModal').style.display = 'block';
        }

        async function saveAsset() {
            const id = document.getElementById('assetId').value;
            const symbol = document.getElementById('assetSymbol').value.trim().toUpperCase();
            const name = document.getElementById('assetName').value.trim();
            const description = document.getElementById('assetDescription').value.trim();
            const thesis = document.getElementById('assetThesis').value.trim();
            const position_size = document.getElementById('assetPosition').value.trim();

            if (!symbol || !name) {
                alert('Symbol and Name are required');
                return;
            }

            try {
                if (id) {
                    // Update existing
                    const { error } = await supabase
                        .from('assets')
                        .update({ name, description, thesis, position_size })
                        .eq('id', id);

                    if (error) throw error;
                } else {
                    // Insert new
                    const { error } = await supabase
                        .from('assets')
                        .insert([{ symbol, name, description, thesis, position_size }]);

                    if (error) throw error;
                }

                closeModal('assetModal');
                loadAssets();
                
                const adminContent = document.getElementById('admin-content');
                adminContent.innerHTML = '<div class="success">‚úì Asset saved successfully!</div>';
                setTimeout(() => adminContent.innerHTML = '', 3000);
            } catch (error) {
                console.error('Error saving asset:', error);
                alert('Error saving asset: ' + error.message);
            }
        }

        async function loadAssetsForEdit() {
            const adminContent = document.getElementById('admin-content');
            
            try {
                const { data, error } = await supabase
                    .from('assets')
                    .select('*')
                    .order('symbol');

                if (error) throw error;

                adminContent.innerHTML = `
                    <h3>Edit Assets</h3>
                    <div class="asset-grid">
                        ${data.map(asset => `
                            <div class="admin-card">
                                <h3>${asset.symbol}</h3>
                                <p>${asset.name}</p>
                                <button class="btn btn-primary" onclick='openAssetModal(${JSON.stringify(asset)})'>Edit</button>
                                <button class="btn btn-danger" onclick="deleteAsset(${asset.id}, '${asset.symbol}')">Delete</button>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading assets:', error);
                adminContent.innerHTML = '<div class="error">Error loading assets</div>';
            }
        }

        async function deleteAsset(id, symbol) {
            if (!confirm(`Delete ${symbol}? This will also delete all associated posts and triggers.`)) return;

            try {
                const { error } = await supabase
                    .from('assets')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                loadAssets();
                loadAssetsForEdit();
            } catch (error) {
                console.error('Error deleting asset:', error);
                alert('Error deleting asset');
            }
        }

        async function manageTriggers() {
            const adminContent = document.getElementById('admin-content');
            
            try {
                const { data: triggers, error: triggerError } = await supabase
                    .from('triggers')
                    .select('*, assets(symbol, name)')
                    .order('created_at', { ascending: false });

                if (triggerError) throw triggerError;

                const { data: assets, error: assetError } = await supabase
                    .from('assets')
                    .select('symbol, name')
                    .order('symbol');

                if (assetError) throw assetError;

                // Populate trigger asset dropdown
                const select = document.getElementById('triggerAsset');
                select.innerHTML = '<option value="">Select Asset</option>' + 
                    assets.map(a => `<option value="${a.symbol}">${a.symbol} - ${a.name}</option>`).join('');

                adminContent.innerHTML = `
                    <h3>HTF Triggers</h3>
                    <button class="btn btn-primary" onclick="openTriggerModal()">+ Add Trigger</button>
                    <div style="margin-top: 2rem;">
                        ${triggers && triggers.length > 0 ? triggers.map(trigger => `
                            <div class="trigger-item" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div>
                                    <strong>${trigger.assets.symbol} - ${trigger.trigger_type.toUpperCase()}</strong>
                                    <p>${trigger.description}</p>
                                </div>
                                <button class="btn btn-danger" onclick="deleteTrigger(${trigger.id})">Delete</button>
                            </div>
                        `).join('') : '<p>No triggers yet. Add your first trigger!</p>'}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading triggers:', error);
                adminContent.innerHTML = '<div class="error">Error loading triggers</div>';
            }
        }

        function openTriggerModal() {
            document.getElementById('triggerModal').style.display = 'block';
        }

        async function saveTrigger() {
            const asset = document.getElementById('triggerAsset').value;
            const type = document.getElementById('triggerType').value;
            const description = document.getElementById('triggerDescription').value.trim();

            if (!asset || !description) {
                alert('Please select an asset and enter a description');
                return;
            }

            try {
                const { error } = await supabase
                    .from('triggers')
                    .insert([{
                        asset_symbol: asset,
                        trigger_type: type,
                        description
                    }]);

                if (error) throw error;

                closeModal('triggerModal');
                manageTriggers();
            } catch (error) {
                console.error('Error saving trigger:', error);
                alert('Error saving trigger');
            }
        }

        async function deleteTrigger(id) {
            if (!confirm('Delete this trigger?')) return;

            try {
                const { error } = await supabase
                    .from('triggers')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                manageTriggers();
            } catch (error) {
                console.error('Error deleting trigger:', error);
            }
        }

        // ===== UTILITY FUNCTIONS =====
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            
            // Clear form fields
            if (modalId === 'postModal') {
                document.getElementById('postTitle').value = '';
                document.getElementById('postContent').value = '';
            } else if (modalId === 'todoModal') {
                document.getElementById('todoText').value = '';
            } else if (modalId === 'triggerModal') {
                document.getElementById('triggerDescription').value = '';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // ===== INITIALIZE APP =====
        window.addEventListener('DOMContentLoaded', () => {
            // Check if Supabase credentials are configured
            if (SUPABASE_URL === 'https://txhgyvmqffjkgnuztxnb.supabase.co' || SUPABASE_KEY === 'sb_publishable_tk6tnApHFqI4e9DpUMslUQ_RRKILC0M') {
                document.querySelector('.container').innerHTML = `
                    <div class="page-section active">
                        <div class="error">
                            <h2>‚ö†Ô∏è Configuration Required</h2>
                            <p><strong>Please update your Supabase credentials in the code:</strong></p>
                            <ol style="margin: 1rem 0; line-height: 2;">
                                <li>Find the CONFIGURATION section at the top of the script</li>
                                <li>Replace <code>YOUR_SUPABASE_URL_HERE</code> with your Project URL</li>
                                <li>Replace <code>YOUR_SUPABASE_ANON_KEY_HERE</code> with your anon public key</li>
                                <li>Get these from: Supabase Dashboard ‚Üí Settings ‚Üí API</li>
                            </ol>
                            <p>Once configured, refresh the page.</p>
                        </div>
                    </div>
                `;
                return;
            }

            // Load initial data
            loadAssets();
        });
    </script>
</body>
</html>
